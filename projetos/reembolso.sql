-- Relatório
select 1 as TIPO, AFG.AFG_PROJET AS C5_XPROJET, AF8.AF8_CLIENT AS C5_CLIENTE, AF8.AF8_LOJA AS C5_LOJA, SA1.A1_NOME, SD1.D1_EMISSAO AS EMISSAO, SD1.D1_DOC AS DOCTO, SC7.C7_OBS AS DETALHE, SUM(SD1.D1_QUANT) AS C6_QUANTOS, SUM(CASE WHEN SD1.D1_QUANT = 0 THEN 0 ELSE CASE WHEN AFG.AFG_XCOB = '2' THEN 0 ELSE SD1.D1_TOTAL + (SD1.D1_TOTAL * 20 / 100) END / SD1.D1_QUANT END) AS C6_UNITARIO, SUM(SD1.D1_TOTAL) AS C6_TOTAL, SUM(CASE WHEN AFG.AFG_XCOB = '2' THEN 0 ELSE SD1.D1_TOTAL + (SD1.D1_TOTAL * 20 / 100) END) AS C6_COBCLI, MIN(AFC.AFC_XPROD) AS AFC_XPROD   from AFG010 AFG   JOIN AF8010 AF8 ON AF8.AF8_FILIAL = AFG.AFG_FILIAL AND AF8.D_E_L_E_T_ = ' '    AND AF8.AF8_PROJET = AFG.AFG_PROJET AND AF8.AF8_XDESP = '2' AND AF8.AF8_PROJET BETWEEN '          ' AND 'ZZZZZZZZZZZZ' AND AF8.AF8_CLIENT + AF8.AF8_LOJA BETWEEN '00556601' AND '00556601'   JOIN SA1010 SA1 ON SA1.A1_FILIAL = '  ' AND SA1.D_E_L_E_T_ = ' ' AND SA1.A1_COD = AF8.AF8_CLIENT    AND SA1.A1_LOJA = AF8.AF8_LOJA   JOIN AF9010 AF9 ON AF9.AF9_FILIAL = AFG.AFG_FILIAL AND AF9.D_E_L_E_T_ = ' '    AND AF9.AF9_PROJET = AFG.AFG_PROJET AND AF9.AF9_REVISA = AFG.AFG_REVISA AND AF9.AF9_TAREFA = AFG.AFG_TAREFA   JOIN AFC010 AFC ON AFC.AFC_FILIAL = AFG.AFG_FILIAL AND AFC.D_E_L_E_T_ = ' '    AND AFC.AFC_PROJET = AFG.AFG_PROJET AND AFC.AFC_REVISA = AFG.AFG_REVISA AND AFC.AFC_EDT = AF9.AF9_EDTPAI   JOIN SC7010 SC7 ON SC7.C7_FILIAL = AFG.AFG_FILIAL AND SC7.D_E_L_E_T_ = ' '    AND SC7.C7_NUMSC = AFG.AFG_NUMSC AND SC7.C7_ITEMSC = AFG.AFG_ITEMSC   JOIN SD1010 SD1 ON SD1.D1_FILIAL = AFG.AFG_FILIAL AND SD1.D_E_L_E_T_ = ' '    AND SD1.D1_PEDIDO = SC7.C7_NUM AND SD1.D1_ITEMPC = SC7.C7_ITEM    AND SD1.D1_EMISSAO BETWEEN '20120101' AND '20120806' AND CASE WHEN AFG.AFG_XCOB = '2' THEN 0 ELSE SD1.D1_TOTAL + (SD1.D1_TOTAL * 20 / 100) END > 0 WHERE AFG.AFG_FILIAL = '01' AND AFG.D_E_L_E_T_ = ' '  GROUP BY AFG.AFG_PROJET, AF8.AF8_CLIENT, AF8.AF8_LOJA, SA1.A1_NOME, SD1.D1_EMISSAO, SD1.D1_DOC, SC7.C7_OBS  UNION ALL select 2 as TIPO, AFR.AFR_PROJET AS C5_XPROJET, AF8.AF8_CLIENT AS C5_CLIENTE, AF8.AF8_LOJA AS C5_LOJA, SA1.A1_NOME, SE2.E2_EMISSAO AS EMISSAO, AFR.AFR_NUM AS DOCTO, COALESCE(LTRIM(RTRIM(SZ8.Z8_DESCRI)) + ' [' + LTRIM(RTRIM(SA2.A2_NOME)) + ']', LTRIM(RTRIM(SA2.A2_NOME))) AS DETALHE, SUM(AFR.AFR_XQTDE) AS C6_QUANTOS, SUM(CASE WHEN AFR.AFR_XQTDE = 0 THEN 0 ELSE AFR.AFR_XVAL_C / AFR.AFR_XQTDE END) AS C6_UNITARIO, SUM(AFR.AFR_VALOR1) AS C6_TOTAL, SUM(AFR.AFR_XVAL_C) AS C6_COBCLI, MIN(AFC.AFC_XPROD) AS AFC_XPROD   from AFR010 AFR   LEFT JOIN SZ8010 SZ8 ON SZ8.Z8_FILIAL = '  ' AND SZ8.D_E_L_E_T_ = ' ' AND SZ8.Z8_DESPESA = AFR.AFR_TIPOD   JOIN AF8010 AF8 ON AF8.AF8_FILIAL = AFR.AFR_FILIAL AND AF8.D_E_L_E_T_ = ' '    AND AF8.AF8_PROJET = AFR.AFR_PROJET AND AF8.AF8_XDESP = '2' AND AF8.AF8_PROJET BETWEEN '          ' AND 'ZZZZZZZZZZZZ' AND AF8.AF8_CLIENT + AF8.AF8_LOJA BETWEEN '00556601' AND '00556601'   JOIN SA1010 SA1 ON SA1.A1_FILIAL = '  ' AND SA1.D_E_L_E_T_ = ' ' AND SA1.A1_COD = AF8.AF8_CLIENT    AND SA1.A1_LOJA = AF8.AF8_LOJA   JOIN AF9010 AF9 ON AF9.AF9_FILIAL = AFR.AFR_FILIAL AND AF9.D_E_L_E_T_ = ' '    AND AF9.AF9_PROJET = AFR.AFR_PROJET AND AF9.AF9_REVISA = AFR.AFR_REVISA AND AF9.AF9_TAREFA = AFR.AFR_TAREFA   JOIN AFC010 AFC ON AFC.AFC_FILIAL = AFR.AFR_FILIAL AND AFC.D_E_L_E_T_ = ' '    AND AFC.AFC_PROJET = AFR.AFR_PROJET AND AFC.AFC_REVISA = AFR.AFR_REVISA AND AFC.AFC_EDT = AF9.AF9_EDTPAI   JOIN SE2010 SE2 ON SE2.E2_FILIAL = AFR.AFR_FILIAL AND SE2.D_E_L_E_T_ = ' '    AND SE2.E2_PREFIXO = AFR.AFR_PREFIX AND SE2.E2_NUM = AFR.AFR_NUM AND SE2.E2_TIPO = AFR.AFR_TIPO AND SE2.E2_PARCELA = AFR.AFR_PARCEL    AND SE2.E2_EMISSAO BETWEEN '20120101' AND '20120806'   JOIN SA2010 SA2 ON SA2.A2_FILIAL = '  ' AND SA2.D_E_L_E_T_ = ' ' AND SA2.A2_COD = SE2.E2_FORNECE    AND SA2.A2_LOJA = SE2.E2_LOJA  WHERE AFR.AFR_FILIAL = '01' AND AFR.D_E_L_E_T_ = ' ' AND AFR.AFR_XVAL_C > 0 GROUP BY AFR.AFR_PROJET, AF8.AF8_CLIENT, AF8.AF8_LOJA, SA1.A1_NOME, SE2.E2_EMISSAO, AFR.AFR_NUM, SA2.A2_NOME, SZ8.Z8_DESCRI  ORDER BY C5_CLIENTE, C5_LOJA, TIPO, C5_XPROJET, DOCTO

-- Geração do Pedido
select SZ9.Z9_DESPESA, SZ9.C5_CLIENTE, SZ9.C5_LOJACLI, SZ9.A1_TIPO, SZ9.Z9_CONDPAG, SZ9.C5_XPROJET, SZ9.C5_XTSKPMS, SZ9.C6_PRODUTO, SUM(SZ9.C6_QTDVEN) AS C6_QTDVEN, SUM(SZ9.C6_PRCVEN) AS C6_PRCVEN 
  from (select SZ9.Z9_DESPESA, AF8.AF8_CLIENT AS C5_CLIENTE, AF8.AF8_LOJA AS C5_LOJACLI, AF8.AF8_PROJET AS C5_XPROJET, AF9.AF9_EDTPAI AS C5_XTSKPMS, MIN(SA1.A1_TIPO) AS A1_TIPO, MIN(SZ9.Z9_CONDPAG) AS Z9_CONDPAG, SD1.D1_COD AS C6_PRODUTO, SUM(SD1.D1_QUANT) AS C6_QTDVEN, SUM(SD1.D1_XVAL_C) AS C6_PRCVEN 
          from AFG010 AFG JOIN AF8010 AF8 ON AF8.AF8_FILIAL = AFG.AFG_FILIAL AND AF8.D_E_L_E_T_ = ' ' AND AF8.AF8_PROJET = AFG.AFG_PROJET AND AF8.AF8_XDESP = '2' JOIN SA1010 SA1 ON SA1.A1_FILIAL = '  ' AND SA1.D_E_L_E_T_ = ' ' AND SA1.A1_COD = AF8.AF8_CLIENT AND SA1.A1_LOJA = AF8.AF8_LOJA JOIN AF9010 AF9 ON AF9.AF9_FILIAL = AFG.AFG_FILIAL AND AF9.D_E_L_E_T_ = ' ' AND AF9.AF9_PROJET = AFG.AFG_PROJET AND AF9.AF9_REVISA = AFG.AFG_REVISA AND AF9.AF9_TAREFA = AFG.AFG_TAREFA JOIN SC7010 SC7 ON SC7.C7_FILIAL = AFG.AFG_FILIAL AND SC7.D_E_L_E_T_ = ' ' AND SC7.C7_NUMSC = AFG.AFG_NUMSC AND SC7.C7_ITEMSC = AFG.AFG_ITEMSC JOIN SD1010 SD1 ON SD1.D1_FILIAL = AFG.AFG_FILIAL AND SD1.D_E_L_E_T_ = ' ' AND SD1.D1_PEDIDO = SC7.C7_NUM AND SD1.D1_ITEMPC = SC7.C7_ITEM AND SD1.D1_XDESP between '000090' AND '000090' JOIN SZ9010 SZ9 ON SZ9.Z9_FILIAL = AFG.AFG_FILIAL AND SZ9.D_E_L_E_T_ = ' ' AND SZ9.Z9_DESPESA = SD1.D1_XDESP AND SZ9.Z9_CONDPAG <> '' AND SZ9.Z9_STATUS = 'A' where AFG.D_E_L_E_T_ = ' ' AND AFG.AFG_FILIAL = '01' group by SZ9.Z9_DESPESA, AF8.AF8_CLIENT, AF8.AF8_LOJA, AF8.AF8_PROJET, AF9.AF9_EDTPAI, SD1.D1_COD 
         union 
           all 
        select SZ9.Z9_DESPESA, AF8.AF8_CLIENT AS C5_CLIENTE, AF8.AF8_LOJA AS C5_LOJACLI, AF8.AF8_PROJET AS C5_XPROJET, AF9.AF9_EDTPAI AS C5_XTSKPMS, MIN(SA1.A1_TIPO) AS A1_TIPO, MIN(SZ9.Z9_CONDPAG) AS Z9_CONDPAG, SZ8.Z8_PRODUTO AS C6_PRODUTO, SUM(AFR.AFR_XQTDE) AS C6_QTDVEN, SUM(AFR.AFR_XVAL_C) AS C6_PRCVEN, AFR.AFR_TIPOD 
          from AFR010 AFR JOIN SZ8010 SZ8 ON SZ8.Z8_FILIAL = '  ' AND SZ8.D_E_L_E_T_ = ' ' AND SZ8.Z8_DESPESA = AFR.AFR_TIPOD JOIN AF8010 AF8 ON AF8.AF8_FILIAL = AFR.AFR_FILIAL AND AF8.D_E_L_E_T_ = ' ' AND AF8.AF8_PROJET = AFR.AFR_PROJET AND AF8.AF8_XDESP = '2' JOIN SA1010 SA1 ON SA1.A1_FILIAL = '  ' AND SA1.D_E_L_E_T_ = ' ' AND SA1.A1_COD = AF8.AF8_CLIENT AND SA1.A1_LOJA = AF8.AF8_LOJA JOIN AF9010 AF9 ON AF9.AF9_FILIAL = AFR.AFR_FILIAL AND AF9.D_E_L_E_T_ = ' ' AND AF9.AF9_PROJET = AFR.AFR_PROJET AND AF9.AF9_REVISA = AFR.AFR_REVISA AND AF9.AF9_TAREFA = AFR.AFR_TAREFA JOIN SE2010 SE2 ON SE2.E2_FILIAL = AFR.AFR_FILIAL AND SE2.D_E_L_E_T_ = ' ' AND SE2.E2_PREFIXO = AFR.AFR_PREFIX AND SE2.E2_NUM = AFR.AFR_NUM AND SE2.E2_TIPO = AFR.AFR_TIPO AND SE2.E2_PARCELA = AFR.AFR_PARCEL JOIN SZ9010 SZ9 ON SZ9.Z9_FILIAL = AFR.AFR_FILIAL AND SZ9.D_E_L_E_T_ = ' ' AND SZ9.Z9_DESPESA = AFR.AFR_XDESP AND SZ9.Z9_CONDPAG <> '' AND SZ9.Z9_STATUS = 'A' 
         WHERE AFR.AFR_FILIAL = '01' AND AFR.D_E_L_E_T_ = ' ' AND AFR.AFR_XDESP between '000090' AND '000090 ' 
         group by SZ9.Z9_DESPESA, AF8.AF8_CLIENT, AF8.AF8_LOJA, AF8.AF8_PROJET, AF9.AF9_EDTPAI, SZ8.Z8_PRODUTO, AFR.AFR_TIPOD) SZ9 
  group by SZ9.Z9_DESPESA, SZ9.C5_CLIENTE, SZ9.C5_LOJACLI, SZ9.A1_TIPO, SZ9.Z9_CONDPAG, SZ9.C5_XPROJET, SZ9.C5_XTSKPMS, SZ9.C6_PRODUTO 
  order by SZ9.Z9_DESPESA, SZ9.C5_CLIENTE, SZ9.C5_LOJACLI, SZ9.A1_TIPO, SZ9.Z9_CONDPAG, SZ9.C5_XPROJET, SZ9.C5_XTSKPMS, SZ9.C6_PRODUTO