-- Itens com diferença atual e final
SELECT * FROM SB2010 WHERE B2_QATU <> B2_QFIM AND D_E_L_E_T_ = ' ';

-- Posição Fechamento - MES 12/2011
SELECT SUM(SB9.B9_CM1 * B9_QINI) AS B9_CM1, SUM(B9_QINI) AS B9_QINI
  FROM SB9010 SB9
 WHERE SB9.D_E_L_E_T_ = ' ' AND SB9.B9_DATA = '20111231' AND SB9.B9_LOCAL = '01'; 

-- Posição Fechamento - MES 11/2011
SELECT SUM(SB9.B9_CM1 * B9_QINI) AS B9_CM1, SUM(B9_QINI) AS B9_QINI
  FROM SB9010 SB9
 WHERE SB9.D_E_L_E_T_ = ' ' AND SB9.B9_DATA = '20111130' AND SB9.B9_LOCAL = '01'; 

-- Posição Atual ou final
SELECT SUM(CASE WHEN B2_QFIM = 0 THEN B2_VFIM1 ELSE B2_QFIM * B2_CMFIM1 END) AS B2_CM1, 
       SUM(B2_QFIM * B2_CMFIM1) AS B2_CMFIM1, SUM(B2_VFIM1) AS B2_VFIM1
  FROM SB2010 
 WHERE B2_FILIAL = '01' AND D_E_L_E_T_ = ' ' AND B2_LOCAL = '01';

-- Diferença entre fechamento
SELECT SUM(B2_VFIM1) AS B2_VFIM1, SUM(B2_CMFIM1) AS B2_CMFIM1
  FROM 
(
SELECT B2_COD, CAST(B2_VFIM1 AS NUMERIC(15, 2)) AS B2_VFIM1, 
       CAST(B2_QFIM * B2_CMFIM1 AS NUMERIC(15, 2)) AS B2_CMFIM1 -- , *
  FROM SB2010 
 WHERE B2_FILIAL = '01' AND D_E_L_E_T_ = ' ' AND B2_LOCAL = '01' 
   AND CAST(B2_VFIM1 AS NUMERIC(15, 2)) <> CAST(B2_QFIM * B2_CMFIM1 AS NUMERIC(15, 2))
ORDER BY B2_COD
) AS TAB 

-- Posição Atual
SELECT SUM(SB2.B2_CM1 * B2_QATU) AS B9_CM1, SUM(B2_QATU) AS B2_QATU
  FROM SB2010 SB2
 WHERE SB2.D_E_L_E_T_ = ' '; 

-- Itens com diferença entre o Kardex e Saldo do Fechamento 12/2011
SELECT KDX.B1_COD, KDX.QUANT, SB9.B9_QINI 
  FROM (SELECT B1_COD, B1_LOCAL, SUM(QUANT) AS QUANT
          FROM KARDEX
         WHERE DATA <= '20111231'
         GROUP BY B1_COD, B1_LOCAL
         HAVING B1_COD <> '') KDX
  LEFT JOIN SB9010 SB9 ON SB9.D_E_L_E_T_ = ' ' AND SB9.B9_DATA = '20111231' AND SB9.B9_COD = KDX.B1_COD
   AND SB9.B9_LOCAL = KDX.B1_LOCAL
 WHERE KDX.QUANT <> SB9.B9_QINI
 ORDER BY KDX.B1_COD;

-- Produtos alterados em 30/12/2011
SELECT * FROM SD3010 WHERE D3_EMISSAO = '20111230' ORDER BY R_E_C_N_O_;

-- Saldos dos fechamentos
SELECT * FROM SB2010 WHERE B2_COD = 'RYB0068-10A';
SELECT * FROM SB9010 WHERE B9_COD = 'RYB0068-10A' AND B9_DATA = '20111231';
SELECT * FROM KARDEX WHERE B1_COD = 'RYB0068-10A' ORDER BY DATA, SEQUENCIA;

SELECT SUM(QUANT) AS QUANTO FROM KARDEX WHERE B1_COD = 'RYB0068-10A';

-- Notas Fiscais
SELECT D1_DOC, D1_LOCAL, * FROM SD1010 WHERE D1_NUMSEQ IN ('133196','135756');

-- Produtos com diferença devido a transposição de tipos
SELECT SUM(B9_QINI) AS B9_QINI, SUM(QUANT) AS QUANT
  FROM
(  
SELECT SB9.B9_COD, SB9.B9_LOCAL, SB9.B9_QINI, SB9.B9_CM1 * SB9.B9_QINI AS CUSTO, KDX.QUANT 
  FROM SB9010 SB9
  JOIN (SELECT D3_COD, D3_LOCAL FROM SD3010 WHERE D3_EMISSAO = '20111230' GROUP BY D3_COD, D3_LOCAL) SD3 
    ON SD3.D3_COD = SB9.B9_COD AND SD3.D3_LOCAL = SB9.B9_LOCAL
 LEFT JOIN (SELECT B1_COD, B1_LOCAL, SUM(QUANT) AS QUANT
              FROM KARDEX
             WHERE DATA <= '20111231'
             GROUP BY B1_COD, B1_LOCAL
            HAVING B1_COD <> '') KDX ON KDX.B1_COD = SB9.B9_COD AND KDX.B1_LOCAL = SB9.B9_LOCAL
  WHERE SB9.B9_DATA = '20111231' AND SB9.B9_QINI <> KDX.QUANT
-- ORDER BY SB9.B9_COD, SB9.B9_LOCAL
) AS TAB; 

SELECT * FROM SB9010 WHERE B9_COD = '40044195' AND B9_DATA = '20111231';
SELECT * FROM SD3010 WHERE D3_COD = 'RYB0068-10A';

-- Exemplos
SELECT B2_COD, CAST(B2_VFIM1 AS NUMERIC(15, 2)) AS B2_VFIM1, 
       CAST(B2_QFIM * B2_CMFIM1 AS NUMERIC(15, 2)) AS B2_CMFIM1 -- , *
  FROM SB2010 
 WHERE B2_FILIAL = '01' AND D_E_L_E_T_ = ' ' AND B2_LOCAL = '01' 
   and B2_COD = 'RYB0068-10A'
   AND CAST(B2_VFIM1 AS NUMERIC(15, 2)) <> CAST(B2_QFIM * B2_CMFIM1 AS NUMERIC(15, 2))

-- Fechamento 31/12/2011
SELECT SB9.* FROM SB9010 SB9 
  JOIN SB2010 SB2 ON SB2.B2_FILIAL = '01' AND SB2.D_E_L_E_T_ = ' ' AND SB2.B2_COD = SB9.B9_COD 
   AND SB2.B2_LOCAL = SB9.B9_LOCAL
 WHERE SB9.B9_FILIAL = '01' AND SB9.B9_DATA = '20111231' AND SB9.D_E_L_E_T_ = ' '
-- AND (SB9.B9_QINI = SB2.B2_QFIM AND SB9.B9_VINI1 = SB2.B2_VFIM1 AND SB9.B9_CM1 = SB2.B2_CMFIM1);
   AND (SB9.B9_QINI <> SB2.B2_QFIM OR SB9.B9_VINI1 <> SB2.B2_VFIM1 OR SB9.B9_CM1 <> SB2.B2_CMFIM1);

-- Posição Atual ou final
SELECT SUM(CASE WHEN B2_QFIM = 0 THEN B2_VFIM1 ELSE B2_QFIM * B2_CMFIM1 END) AS B2_CM1, 
       SUM(B2_QFIM * B2_CMFIM1) AS B2_CMFIM1, SUM(B2_VFIM1) AS B2_VFIM1
  FROM SB2010 
 WHERE B2_FILIAL = '01' AND D_E_L_E_T_ = ' ' AND B2_LOCAL = '01';

-- Conferência B2 e B9
SELECT * FROM SB2010 
 WHERE B2_FILIAL = '01' AND D_E_L_E_T_ = ' ' AND B2_LOCAL = '01' 
   AND B2_QFIM = 0 AND B2_VFIM1 > 0;

-- Produto especifico
SELECT B2_QFIM, B2_VFIM1, B2_CMFIM1, * FROM SB2010 
 WHERE B2_FILIAL = '01' AND D_E_L_E_T_ = ' ' AND B2_LOCAL = '01' 
   AND B2_COD = 'RYB0068-10A';
   
SELECT B9_QINI, B9_VINI1, B9_CM1, * FROM SB9010 
 WHERE B9_FILIAL = '01' AND D_E_L_E_T_ = ' ' AND B9_LOCAL = '01' 
   AND B9_COD = 'RYB0068-10A' AND B9_DATA = '20111231';
   
-- 1) Correção do valor final em estoque
UPDATE SB2010 
   SET B2_VFIM1 = CAST(B2_QFIM * B2_CMFIM1 AS NUMERIC(15, 2))
 WHERE B2_COD IN 
 (
SELECT B2_COD
  FROM SB2010 
 WHERE B2_FILIAL = '01' AND D_E_L_E_T_ = ' ' AND B2_LOCAL = '01'
   AND CAST(B2_VFIM1 AS NUMERIC(15, 2)) <> CAST(B2_QFIM * B2_CMFIM1 AS NUMERIC(15, 2))
 );

-- 2) Correção do fechamento
UPDATE SB9010
   SET B9_QINI = SB9.B2_QFIM, B9_VINI1 = SB9.B2_VFIM1, B9_CM1 = SB9.B2_CMFIM1
  FROM 
(     
SELECT SB9.B9_FILIAL, SB9.B9_COD, SB9.B9_LOCAL, SB9.B9_DATA, SB2.B2_QFIM, SB2.B2_VFIM1, 
       SB2.B2_CMFIM1 
  FROM SB9010 SB9 
  JOIN SB2010 SB2 ON SB2.B2_FILIAL = '01' AND SB2.D_E_L_E_T_ = ' ' AND SB2.B2_COD = SB9.B9_COD 
   AND SB2.B2_LOCAL = SB9.B9_LOCAL
 WHERE SB9.B9_FILIAL = '01' AND SB9.B9_DATA = '20111231' AND SB9.D_E_L_E_T_ = ' '
   AND (SB9.B9_QINI <> SB2.B2_QFIM OR SB9.B9_VINI1 <> SB2.B2_VFIM1 OR SB9.B9_CM1 <> SB2.B2_CMFIM1)
) SB9 
WHERE SB9010.B9_FILIAL = SB9.B9_FILIAL AND SB9010.B9_COD = SB9.B9_COD AND SB9010.B9_LOCAL = SB9.B9_LOCAL
  AND SB9010.B9_DATA = SB9.B9_DATA;
  
-- Copia/Limpeza do fechamento
SELECT * INTO SB9_122011 FROM SB9010 WHERE B9_DATA = '20111231';  

DELETE FROM SB9010 WHERE B9_DATA = '20111231';