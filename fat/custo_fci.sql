SELECT B1_DESC, B1_POSIPI, D2_COD, B1_UM, ROUND(SUM(TOTOPE), 2) AS OPERACAO, ROUND(SUM(PARIMP), 2) AS IMPORTADO, 
       ROUND(SUM(PARIMP) / SUM(TOTOPE) * 100, 2) AS CONTIMP
  FROM
(
select SD2.D2_ITEM, SB1.B1_DESC, SB1.B1_POSIPI, SB1.B1_UM, D2_COD, D2_QUANT, D2_PRCVEN, D2_LOTECTL, D2_TOTAL + D2_IPI AS D2_TOTAL, 
       D1_BASEICM, D1_DOC, D1_FORNECE,
       D2_QUANT * (D1_BASEICM / D1_QUANT) AS PARIMP, D2_TOTAL + D2_IPI AS TOTOPE,
       ROUND((D2_QUANT * (D1_BASEICM / D1_QUANT) / D2_TOTAL + D2_IPI) * 100, 2) AS CONTIMP
  from SD2010 SD2
  join SB8010 SB8 ON SB8.D_E_L_E_T_ = '' AND SB8.B8_LOTECTL = SD2.D2_LOTECTL AND SB8.B8_PRODUTO = SD2.D2_COD
  join SD1010 SD1 ON SD1.D_E_L_E_T_ = ' ' AND SD1.D1_DOC = SB8.B8_DOC AND SD1.D1_SERIE = SB8.B8_SERIE AND SD1.D1_FORNECE = SB8.B8_CLIFOR 
   AND SD1.D1_LOJA = SB8.B8_LOJA AND SD1.D1_COD = SB8.B8_PRODUTO
  join SB1010 SB1 ON SB1.D_E_L_E_T_ = '' AND SB1.B1_COD = SD2.D2_COD
 WHERE SD2.D2_DOC = '000007929'
) imp
group by B1_DESC, B1_POSIPI, D2_COD, B1_UM