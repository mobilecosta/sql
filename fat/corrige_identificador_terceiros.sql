-- Saldo SB2
SELECT B2_QTER, B2_QNPT, *  
  FROM SB2010 WHERE B2_QTER < 0;

-- Remessa de Terceiros
SELECT SD1.D1_TIPO, SD1.D1_QUANT, SB6.B6_QUANT, SB6.B6_SALDO, SD1.*
  FROM SD1010 SD1
  JOIN SF4010 SF4 ON SF4.D_E_L_E_T_ = ' ' AND SF4.F4_FILIAL = SD1.D1_FILIAL AND SF4.F4_CODIGO = SD1.D1_TES
   AND SF4.F4_PODER3 = 'R'
  LEFT JOIN SB6010 SB6 ON SB6.D_E_L_E_T_ = ' ' AND SB6.B6_FILIAL = SD1.D1_FILIAL AND SB6.B6_IDENT = SD1.D1_IDENTB6 
   AND SB6.B6_PRODUTO =  SD1.D1_COD AND SB6.B6_PODER3 = 'R'
 WHERE SD1.D_E_L_E_T_ = ' '  AND SD1.D1_QUANT > 0 AND SB6.B6_FILIAL IS NULL

SELECT SD2.D2_TIPO, SD2.D2_QUANT, SB6.B6_QUANT, SB6.B6_SALDO, SD2.*
  FROM SD2010 SD2
  JOIN SF4010 SF4 ON SF4.D_E_L_E_T_ = ' ' AND SF4.F4_FILIAL = SD2.D2_FILIAL AND SF4.F4_CODIGO = SD2.D2_TES
   AND SF4.F4_PODER3 = 'R'
  LEFT JOIN SB6010 SB6 ON SB6.D_E_L_E_T_ = ' ' AND SB6.B6_FILIAL = SD2.D2_FILIAL AND SB6.B6_IDENT = SD2.D2_IDENTB6 
   AND SB6.B6_PRODUTO =  SD2.D2_COD AND SB6.B6_PODER3 = 'R'
 WHERE SD2.D_E_L_E_T_ = ' '  AND SD2.D2_QUANT > 0 AND SB6.B6_FILIAL IS NULL

-- Devolução de Terceiros vinculados a nota original sem movimento de terceiros
-- 1) SELECT SD1.* INTO SD1010_T Copia para tabela temporária
-- 2) SELECT * INTO SF4010_NEW Geração das Novas TES
-- 3) SELECT SD2.D2_EMISSAO, SF4_1.F4_PODER3, SD1.D1_IDENTB6, SD1.D1_TES, SD2.D2_TES, SD2.D2_IDENTB6, SD2.D2_NFORI, SD2.D2_SERIORI, 
--           SD2.D2_CLIENTE, SD2.D2_LOJA, SD2.D2_COD, SB6_1.B6_IDENT, SD2.D2_TIPO, SD2.D2_QUANT, SB6.B6_QUANT, SB6.B6_SALDO, SD2.*
--     ORDER BY SD2.D2_TES, SD2.D2_EMISSAO

-- 4) 
UPDATE SF4010_NEW SET F4_PODER3 = 'R', F4_MSBLQL = '1' - Troca para remessa e bloqueio
-- 5)
UPDATE SF4010_NEW 
      SET F4_TES = CASE WHEN F4_CODIGO = '030' THEN '456' ELSE
                   CASE WHEN F4_CODIGO = '079' THEN '457' ELSE 
                   CASE WHEN F4_CODIGO = '086' THEN '458' ELSE '459' END END END;
-- 6) 
UPDATE SF4010_NEW SET F4_PODER3 = 'R', F4_MSBLQL = '1', F4_CODIGO = '879';

-- Insere as novas TES
SELECT * INTO SF4_INSERT FROM SF4010_NEW;
-- UPDATE SF4_INSERT SET F4_CODIGO = F4_TES;
-- ALTER TABLE SF4_INSERT DROP COLUMN F4_TES;

UPDATE SF4_INSERT SET R_E_C_N_O_ = 608 WHERE F4_CODIGO = '456';
UPDATE SF4_INSERT SET R_E_C_N_O_ = 609 WHERE F4_CODIGO = '457';
UPDATE SF4_INSERT SET R_E_C_N_O_ = 610 WHERE F4_CODIGO = '458';
UPDATE SF4_INSERT SET R_E_C_N_O_ = 611 WHERE F4_CODIGO = '459';
UPDATE SF4_INSERT SET R_E_C_N_O_ = 612 WHERE F4_CODIGO = '879';
UPDATE SF4_INSERT SET R_E_C_N_O_ = 613 WHERE F4_CODIGO = '880';
UPDATE SF4_INSERT SET R_E_C_N_O_ = 614 WHERE F4_CODIGO = '881';
UPDATE SF4_INSERT SET R_E_C_N_O_ = 615 WHERE F4_CODIGO = '460';

INSERT INTO SF4010
SELECT * FROM SF4_INSERT;
DROP TABLE SF4_INSERT;

SELECT * FROM SF4010_NEW;

-- Troca para a nova TES
UPDATE SD1010
   SET D1_TES = SF4010_NEW.F4_TES
  FROM SD1010_T
  JOIN SF4010_NEW ON SF4010_NEW.F4_CODIGO = SD1010_T.D1_TES
 WHERE SD1010_T.R_E_C_N_O_ =  SD1010.R_E_C_N_O_;
 
-- Remessas de Terceiros
SELECT SD1.D1_DOC, SD1.D1_SERIE, SD1.D1_TIPO, SD1.D1_QUANT, SD1.D1_QUANT - 
       COALESCE((SELECT SUM(SD2.D2_QUANT) AS D2_QUANT
          FROM SD2010 SD2
          JOIN SF4010 SF4 ON SF4.D_E_L_E_T_ = ' ' AND SF4.F4_FILIAL = SD2.D2_FILIAL AND SF4.F4_CODIGO = SD2.D2_TES
           AND SF4.F4_PODER3 = 'D'
         WHERE SD2.D_E_L_E_T_ = ' '  AND SD2.D2_QUANT > 0 AND SD2.D2_NFORI = SD1.D1_DOC AND SD2.D2_SERIORI = SD1.D1_SERIE
           AND SD2.D2_ITEMORI = SD1.D1_ITEM), 0) AS D2_SALDO, SB6.B6_SALDO, SD1.*
  FROM SD1010 SD1
  JOIN SF4010 SF4 ON SF4.D_E_L_E_T_ = ' ' AND SF4.F4_FILIAL = SD1.D1_FILIAL AND SF4.F4_CODIGO = SD1.D1_TES
   AND SF4.F4_PODER3 = 'R'
  LEFT JOIN SB6010 SB6 ON SB6.D_E_L_E_T_ = ' ' AND SB6.B6_FILIAL = SD1.D1_FILIAL AND SB6.B6_IDENT = SD1.D1_IDENTB6 
   AND SB6.B6_PRODUTO = SD1.D1_COD AND SB6.B6_PODER3 = 'R'
 WHERE SD1.D_E_L_E_T_ = ' '  AND SD1.D1_QUANT > 0 AND SD1.D1_COD = '149450-1'

SELECT D1_ITEM, * FROM SD1010 WHERE D1_DOC = '000157094' AND D1_COD = '149450-1';
SELECT * FROM SB6010 WHERE B6_DOC = '000157094' AND B6_PRODUTO = '149450-1';
SELECT * FROM SD2010 WHERE D2_NFORI = '000157094' AND D2_COD = '149450-1';
   
SELECT SD1.D1_IDENTB6, SD1.D1_NFORI, SD1.* FROM SD1010 SD1
  JOIN SF4010 SF4 ON SF4.D_E_L_E_T_ = ' ' AND SF4.F4_FILIAL = SD1.D1_FILIAL AND SF4.F4_CODIGO = SD1.D1_TES
   AND SF4.F4_PODER3 = 'R'
 WHERE SD1.D_E_L_E_T_ = ' ' AND SD1.D1_COD = '149450-1';
 
-- Entrada 
SELECT D_E_L_E_T_, D1_DOC, D1_SERIE, D1_IDENTB6, * FROM SD1010 
 WHERE D1_DOC IN ('097108', '086595') AND D1_FORNECE IN ('004476', '005332');
 
-- Terceiros
SELECT * FROM SB6010 
 WHERE B6_DOC IN ('097108', '086595') AND B6_CLIFOR IN ('004476', '005332') AND B6_PODER3 = 'R';

-- Saídas como devolução
 SELECT SD2.R_E_C_N_O_, SD2.D2_EMISSAO, SF4_1.F4_PODER3, SD1.D1_IDENTB6, SD1.D1_TES, SD2.D2_TES, SD2.D2_IDENTB6, SD2.D2_NFORI, SD2.D2_SERIORI, 
        SD2.D2_CLIENTE, SD2.D2_LOJA, SD2.D2_COD, SB6_1.B6_IDENT, SD2.D2_TIPO, SD2.D2_QUANT, SB6.B6_QUANT, SB6.B6_SALDO, SD2.*
  FROM SD2010 SD2
  JOIN SF4010 SF4 ON SF4.D_E_L_E_T_ = ' ' AND SF4.F4_FILIAL = SD2.D2_FILIAL AND SF4.F4_CODIGO = SD2.D2_TES
   AND SF4.F4_PODER3 = 'D'
  LEFT JOIN SB6010 SB6 ON SB6.D_E_L_E_T_ = ' ' AND SB6.B6_FILIAL = SD2.D2_FILIAL AND SB6.B6_IDENT = SD2.D2_IDENTB6 
   AND SB6.B6_PRODUTO =  SD2.D2_COD AND SB6.B6_PODER3 = 'R'
  LEFT JOIN SB6010 SB6_1 ON SB6_1.D_E_L_E_T_ = ' ' AND SB6_1.B6_FILIAL = SD2.D2_FILIAL
   AND SB6.B6_DOC = SD2.D2_NFORI AND SB6_1.B6_SERIE = SD2.D2_SERIORI AND SB6_1.B6_CLIFOR = SD2.D2_CLIENTE 
   AND SB6_1.B6_LOJA = SD2.D2_LOJA AND SB6_1.B6_PRODUTO = SD2.D2_COD AND SB6_1.B6_PODER3 = 'R'
  LEFT JOIN SD1010 SD1 ON SD1.D_E_L_E_T_ = ' ' AND SD1.D1_FILIAL = SD2.D2_FILIAL
   AND SD1.D1_DOC = SD2.D2_NFORI AND SD1.D1_SERIE = SD2.D2_SERIORI AND SD1.D1_FORNECE = SD2.D2_CLIENTE 
   AND SD1.D1_LOJA = SD2.D2_LOJA AND SD1.D1_COD = SD2.D2_COD
  LEFT JOIN SF4010 SF4_1 ON SF4_1.D_E_L_E_T_ = ' ' AND SF4_1.F4_FILIAL = SD2.D2_FILIAL AND SF4_1.F4_CODIGO = SD1.D1_TES
 WHERE SD2.D_E_L_E_T_ = ' '  AND SD2.D2_QUANT > 0 AND SB6.B6_FILIAL IS NULL; 

-- Entrada como devolução 
SELECT SD1.R_E_C_N_O_, SB6_1.B6_IDENTB6, SD2.D2_TES, SF4_1.F4_PODER3, SF4.F4_PODER3, SD1.D1_IDENTB6, SD1.D1_NFORI, SD1.D1_TIPO, SD1.D1_QUANT, 
       SB6.B6_QUANT, SB6.B6_SALDO, SD1.*
  FROM SD1010 SD1
  JOIN SF4010 SF4 ON SF4.D_E_L_E_T_ = ' ' AND SF4.F4_FILIAL = SD1.D1_FILIAL AND SF4.F4_CODIGO = SD1.D1_TES
   AND SF4.F4_PODER3 = 'D'
  LEFT JOIN SB6010 SB6 ON SB6.D_E_L_E_T_ = ' ' AND SB6.B6_FILIAL = SD1.D1_FILIAL AND SB6.B6_IDENT = SD1.D1_IDENTB6 
   AND SB6.B6_PRODUTO =  SD1.D1_COD AND SB6.B6_PODER3 = 'R'
  LEFT JOIN SB6010 SB6_1 ON SB6_1.D_E_L_E_T_ = ' ' AND SB6_1.B6_FILIAL = SD1.D1_FILIAL
   AND SB6.B6_DOC = SD1.D1_NFORI AND SB6_1.B6_SERIE = SD1.D1_SERIORI AND SB6_1.B6_CLIFOR = SD1.D1_FORNECE
   AND SB6_1.B6_LOJA = SD1.D1_LOJA AND SB6_1.B6_PRODUTO = SD1.D1_COD AND SB6_1.B6_PODER3 = 'R'
  LEFT JOIN SD2010 SD2 ON SD2.D_E_L_E_T_ = ' ' AND SD2.D2_FILIAL = SD1.D1_FILIAL
   AND SD2.D2_DOC = SD1.D1_NFORI AND SD2.D2_SERIE = SD1.D1_SERIORI AND SD2.D2_CLIENTE = SD1.D1_FORNECE
   AND SD2.D2_LOJA = SD1.D1_LOJA AND SD2.D2_COD = SD1.D1_COD
  LEFT JOIN SF4010 SF4_1 ON SF4_1.D_E_L_E_T_ = ' ' AND SF4_1.F4_FILIAL = SD2.D2_FILIAL AND SF4_1.F4_CODIGO = SD2.D2_TES
WHERE SD1.D_E_L_E_T_ = ' '  AND SD1.D1_QUANT > 0 AND SB6.B6_FILIAL IS NULL;

-- Novos números
UPDATE SF4010_NEW 
   SET F4_CODIGO = CASE WHEN F4_CODIGO = '715' THEN '880' ELSE
                      CASE WHEN F4_CODIGO = '799' THEN '881' ELSE '460' END END,
       F4_PODER3 = 'N', F4_MSBLQL = '1';

SELECT * INTO SF4_INSERT FROM SF4010_NEW;

UPDATE SF4_INSERT SET R_E_C_N_O_ = 613 WHERE F4_CODIGO = '880';
UPDATE SF4_INSERT SET R_E_C_N_O_ = 614 WHERE F4_CODIGO = '881';
UPDATE SF4_INSERT SET R_E_C_N_O_ = 615 WHERE F4_CODIGO = '460';

INSERT INTO SF4010
SELECT * FROM SF4_INSERT;
DROP TABLE SF4_INSERT;

-- Troca 715 por 880
UPDATE SD2010 
   SET D2_IDENTB6 = '', D2_TES = '880'
 WHERE R_E_C_N_O_ = 7078;

-- Troca 799 por 881
UPDATE SD2010 
   SET D2_IDENTB6 = '', D2_TES = '881'
 WHERE R_E_C_N_O_ = 7060

-- Troca 299 por 460
UPDATE SD1010 
   SET D1_IDENTB6 = '', D1_TES = '460'
 WHERE R_E_C_N_O_ = 26196;
 
 -- Produto 00487 e 00488
 SELECT * FROM SD1010 
  WHERE D1_COD IN ('00487','00488')
  ORDER BY D1_COD, R_E_C_N_O_;
  
-- Produto 00487 = 62 e 00488 = 199
 SELECT D2_IDENTB6, R_E_C_N_O_, D2_EMISSAO, D2_DOC, D2_NFORI, * FROM SD2010 
  WHERE D_E_L_E_T_ = ' ' AND D2_COD IN ('00487','00488')
  ORDER BY D2_COD, D2_EMISSAO, R_E_C_N_O_;  
  
UPDATE SD2010
   SET D2_IDENTB6 = '', D2_NFORI = '', D2_SERIORI = '', D2_ITEMORI = '', D2_TES = '881'
 WHERE D_E_L_E_T_ = ' ' AND D2_COD = '00487' AND NOT R_E_C_N_O_ IN (186, 188);

SELECT D2_TES, D2_IDENTB6, R_E_C_N_O_, D2_EMISSAO, D2_DOC, D2_NFORI, * FROM SD2010 
  WHERE D_E_L_E_T_ = ' ' AND D2_COD = '00488' AND D2_TES = '799'
  ORDER BY D2_COD, D2_EMISSAO, R_E_C_N_O_;  
    
UPDATE SD2010
   SET D2_IDENTB6 = '142750', D2_NFORI = '000000032', D2_SERIORI = '13', D2_ITEMORI = '0004'
 WHERE D_E_L_E_T_ = ' ' AND D2_COD = '00488' AND D2_TES = '799';
   
SELECT D1_DOC, D1_SERIE, D1_IDENTB6, * FROM SD1010 
  WHERE D_E_L_E_T_ = ' ' AND D1_COD = '00488';  

SELECT * FROM SB6010 
  WHERE D_E_L_E_T_ = ' ' AND B6_PRODUTO = '00488';  
  
 SELECT SD1.D1_IDENTB6, SD1.D1_DOC, SD2.R_E_C_N_O_
  FROM SD2010 SD2
  JOIN SD1010 SD1 ON SD1.D1_FILIAL = SD2.D2_FILIAL AND SD1.D1_DOC = SD2.D2_NFORI
   AND SD1.D1_SERIE = SD2.D2_SERIORI AND SD1.D1_FORNECE = SD2.D2_CLIENTE AND SD1.D1_LOJA = SD2.D2_LOJA
   AND SD1.D1_ITEM = SD2.D2_ITEMORI AND SD1.D1_IDENTB6 <> ''
 WHERE SD2.D_E_L_E_T_ = ' ' AND SD2.D2_COD = '00488' AND SD2.D2_TES = '799';

-- Remessa de Terceiro de 2007 e 2008 sem retorno 
SELECT SD1.*, SB6.* 
  FROM SB6010 SB6 
  LEFT JOIN SD1010 SD1 ON SD1.D_E_L_E_T_ = ' ' AND SD1.D1_FILIAL = SB6.B6_FILIAL AND SD1.D1_DOC = SB6.B6_DOC
   AND SD1.D1_SERIE = SB6.B6_SERIE AND SD1.D1_FORNECE = SB6.B6_CLIFOR AND SD1.D1_LOJA = SB6.B6_LOJA
   AND SD1.D1_COD = SB6.B6_PRODUTO
 WHERE LEFT(SB6.B6_EMISSAO, 4) IN ('2007', '2008') AND SB6.B6_SALDO > 0;

-- Novos números
DROP TABLE SF4_INSERT;
SELECT * INTO SF4_INSERT 
  FROM SF4010
 WHERE D_E_L_E_T_ = ' ' AND F4_CODIGO IN ('121', '227');

UPDATE SF4_INSERT
   SET F4_CODIGO = CASE WHEN F4_CODIGO = '121' THEN '461' ELSE '462' END,
       F4_PODER3 = 'N', F4_MSBLQL = '1';

UPDATE SF4_INSERT SET R_E_C_N_O_ = 616 WHERE F4_CODIGO = '461';
UPDATE SF4_INSERT SET R_E_C_N_O_ = 617 WHERE F4_CODIGO = '462';

INSERT INTO SF4010
SELECT * FROM SF4_INSERT;
DROP TABLE SF4_INSERT;

SELECT * FROM SF4010 ORDER BY R_E_C_N_O_;

-- Troca a TES
UPDATE SD1010
   SET D1_TES = CASE WHEN D1_TES = '121' THEN '461' ELSE '462' END
 WHERE R_E_C_N_O_ IN
(
SELECT SD1.R_E_C_N_O_ 
  FROM SB6010 SB6 
  LEFT JOIN SD1010 SD1 ON SD1.D_E_L_E_T_ = ' ' AND SD1.D1_FILIAL = SB6.B6_FILIAL AND SD1.D1_DOC = SB6.B6_DOC
   AND SD1.D1_SERIE = SB6.B6_SERIE AND SD1.D1_FORNECE = SB6.B6_CLIFOR AND SD1.D1_LOJA = SB6.B6_LOJA
   AND SD1.D1_COD = SB6.B6_PRODUTO
 WHERE LEFT(SB6.B6_EMISSAO, 4) IN ('2007', '2008') AND SB6.B6_SALDO > 0
); 