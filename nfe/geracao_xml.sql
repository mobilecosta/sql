-- 1. Deleção de registros inválidos
SELECT * INTO SPED050_06072012 FROM SPED050 WHERE ID_ENT = '000229';

DELETE FROM SPED050 WHERE ID_ENT = '000229';

SELECT * FROM SPED050 WHERE NFE_ID IN ('2  001656', '2  001657')
SELECT * FROM SPED050_000001 WHERE NFE_ID IN ('2  001656', '2  001657')

-- 2. Conferência da data da nota
SELECT NFE.DATE_NFE, S050.R_E_C_N_O_ FROM SPED050 S050
  JOIN (SELECT F2_SERIE + F2_DOC AS NFE_ID, F2_EMISSAO AS DATE_NFE
          FROM SF2010
         WHERE D_E_L_E_T_ = ' ' AND F2_FILIAL = '01' AND F2_CHVNFE <> ''
         UNION  
        SELECT F1_SERIE + F1_DOC AS NFE_ID, F1_EMISSAO AS DATE_NFE
          FROM SF1010
         WHERE D_E_L_E_T_ = ' ' AND F1_FILIAL = '01' AND F1_CHVNFE <> '') NFE ON NFE.NFE_ID = S050.NFE_ID 
 WHERE S050.D_E_L_E_T_ = ' ' AND NFE.DATE_NFE <> S050.DATE_NFE
 ORDER BY S050.NFE_ID;
 
-- Ajusta a data no SPED050
UPDATE SPED050 
   SET DATE_NFE = NFE.DATE_NFE
  FROM 
(
SELECT NFE.DATE_NFE, S050.R_E_C_N_O_ FROM SPED050 S050
  JOIN (SELECT F2_SERIE + F2_DOC AS NFE_ID, F2_EMISSAO AS DATE_NFE
          FROM SF2010
         WHERE D_E_L_E_T_ = ' ' AND F2_FILIAL = '01' AND F2_CHVNFE <> ''
         UNION  
        SELECT F1_SERIE + F1_DOC AS NFE_ID, F1_EMISSAO AS DATE_NFE
          FROM SF1010
         WHERE D_E_L_E_T_ = ' ' AND F1_FILIAL = '01' AND F1_CHVNFE <> '') NFE ON NFE.NFE_ID = S050.NFE_ID 
 WHERE S050.D_E_L_E_T_ = ' ' AND NFE.DATE_NFE <> S050.DATE_NFE
) NFE
 WHERE SPED050.R_E_C_N_O_ = NFE.R_E_C_N_O_;

-- 3. Notas não localizada
SELECT NFE.DATE_NFE, S050.* FROM SPED050 S050
  LEFT JOIN (SELECT F2_SERIE + F2_DOC AS NFE_ID, F2_EMISSAO AS DATE_NFE
               FROM SF2010
              WHERE D_E_L_E_T_ = ' ' AND F2_FILIAL = '01' AND F2_CHVNFE <> ''
              UNION  
             SELECT F1_SERIE + F1_DOC AS NFE_ID, F1_EMISSAO AS DATE_NFE
               FROM SF1010
              WHERE D_E_L_E_T_ = ' ' AND F1_FILIAL = '01' AND F1_CHVNFE <> ''
              UNION
             SELECT F3_SERIE + F3_NFISCAL AS NFE_ID, F3_EMISSAO AS DATE_NFE 
               FROM SF3010 
              WHERE D_E_L_E_T_ = ' ' AND F3_OBSERV LIKE '%CANCEL%') NFE ON NFE.NFE_ID = S050.NFE_ID 
 WHERE S050.D_E_L_E_T_ = ' ' AND NFE.NFE_ID IS NULL
 ORDER BY S050.NFE_ID;

-- 4. Nota 1656 
SELECT F2_FILIAL, D_E_L_E_T_, * FROM SF2010 WHERE F2_DOC LIKE '%1656%';
SELECT F3_TIPO, * FROM SF3010 WHERE F3_NFISCAL LIKE '%1656%';

SELECT F1_FILIAL, F1_CHVNFE, D_E_L_E_T_, * FROM SF1010 WHERE F1_DOC LIKE '%1656%';
SELECT F2_FILIAL, F2_CHVNFE, D_E_L_E_T_, * FROM SF2010 WHERE F2_DOC LIKE '%1656%';

-- Ano 2009
SELECT * FROM SPED050 WHERE D_E_L_E_T_ = ' ' AND DATE_NFE BETWEEN '20090101' AND '20091231'
ORDER BY DATE_NFE;

-- Notas Emitidas
SELECT LEFT(DATE_NFE, 6)
  FROM
(
SELECT F2_SERIE, F2_DOC, F2_EMISSAO AS DATE_NFE
  FROM SF2010
 WHERE D_E_L_E_T_ = ' ' AND F2_FILIAL = '01' AND F2_CHVNFE <> '' 
 UNION  
SELECT F1_SERIE, F1_DOC, F1_EMISSAO AS DATE_NFE
  FROM SF1010
 WHERE D_E_L_E_T_ = ' ' AND F1_FILIAL = '01' AND F1_CHVNFE <> ''
) NFE
WHERE F2_SERIE = '1'
GROUP BY LEFT(DATE_NFE, 6)

