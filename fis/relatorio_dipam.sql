-- F3_EMISSAO;F3_ENTRADA;F3_ESTADO;F3_CFO;F3_NFISCAL;F3_SERIE;CODIGO;NOME;CNPJ;F3_VALCONT;F3_BASEICM;F3_ALIQICM;F3_VALICM;F3_ISENICM;F3_OUTRICM;F3_OBSERV

SELECT SF3.F3_EMISSAO + ';', SF3.F3_ENTRADA + ';', SF3.F3_ESTADO + ';', SF3.F3_CFO + ';', 
       SF3.F3_NFISCAL + ';', SF3.F3_SERIE + ';',  PES.CODIGO + ';', PES.NOME + ';', PES.CNPJ + ';',
       SF3.F3_VALCONT, ';', SF3.F3_BASEICM, ';', SF3.F3_ALIQICM, ';', SF3.F3_VALICM, ';', 
       SF3.F3_ISENICM, ';', SF3.F3_OUTRICM, ';', SF3.F3_OBSERV
  FROM SF3010 SF3
  LEFT JOIN (SELECT 'C' + SA1.A1_COD + SA1.A1_LOJA AS CODIGO, SA1.A1_NOME AS NOME, SA1.A1_CGC AS CNPJ
               FROM SF3010 SF3
               JOIN SA1010 SA1 ON SA1.D_E_L_E_T_ = ' ' AND SA1.A1_FILIAL = '  ' 
                AND SA1.A1_COD = SF3.F3_CLIEFOR AND SA1.A1_LOJA = SF3.F3_LOJA
              WHERE SF3.D_E_L_E_T_ = ' ' AND SF3.F3_FILIAL = '01' AND SF3.F3_ENTRADA BETWEEN '20110101' 
                AND '20111232' 
                AND (SF3.F3_CFO IN ('5949', '6949', '7949') OR SF3.F3_TIPO IN ('B', 'D'))
                AND SF3.F3_CODISS = ''
              GROUP BY SA1.A1_COD, SA1.A1_LOJA, SA1.A1_NOME, SA1.A1_CGC
              UNION ALL
             SELECT 'F' + SA2.A2_COD + SA2.A2_LOJA AS CODIGO, SA2.A2_NOME AS NOME, SA2.A2_CGC AS CNPJ
               FROM SF3010 SF3
               JOIN SA2010 SA2 ON SA2.D_E_L_E_T_ = ' ' AND SA2.A2_FILIAL = '  ' 
                AND SA2.A2_COD = SF3.F3_CLIEFOR AND SA2.A2_LOJA = SF3.F3_LOJA
              WHERE SF3.D_E_L_E_T_ = ' ' AND SF3.F3_FILIAL = '01' AND SF3.F3_ENTRADA BETWEEN '20110101' 
                AND '20111232' AND SF3.F3_CFO IN ('1949', '2949')
                AND SF3.F3_CODISS = ''
              GROUP BY SA2.A2_COD, SA2.A2_LOJA, SA2.A2_NOME, SA2.A2_CGC) PES ON 
       PES.CODIGO = CASE WHEN (SF3.F3_CFO IN ('5949', '6949', '7949') OR SF3.F3_TIPO IN ('B', 'D')) 
                         THEN 'C' ELSE 'F' END + SF3.F3_CLIEFOR + SF3.F3_LOJA
 WHERE SF3.D_E_L_E_T_ = ' ' AND SF3.F3_FILIAL = '01' 
   AND SF3.F3_ENTRADA BETWEEN '20110101' AND '20111232'
   AND SF3.F3_CFO IN ('1949', '2949', '5949', '6949', '7949')
   AND SF3.F3_CODISS = ''
 ORDER BY SF3.F3_EMISSAO, SF3.F3_CFO, SF3.F3_NFISCAL, SF3.F3_SERIE;