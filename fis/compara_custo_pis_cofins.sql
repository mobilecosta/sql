SELECT D1_DTDIGIT, D1_DOC, D1_SERIE, D1_FORNECE, D1_LOJA, D1_COD, D1_ITEM, D1_TOTAL, D1_VALIPI,
       D1_DESPESA, D1_VALFRE, D1_SEGURO,  
       D1_ALQIMP5, D1_VALIMP5 - D1_VALCMAJ AS COF_CALC, 
       CASE WHEN D1_ALQIMP5 > 7.6 THEN ROUND(D1_BASIMP5 * 7.6 / 100, 2) ELSE D1_VALIMP5 - D1_VALCMAJ END AS COF_CRD,
       D1_ALQIMP6, D1_VALIMP6 AS PIS_CALC, 
       CASE WHEN D1_ALQIMP6 > 1.65 THEN ROUND(D1_BASIMP5 * 1.65 / 100, 2) ELSE D1_VALIMP6 END AS PIS_CRD,
       D1_DESPESA,
       D1_TOTAL + D1_DESPESA + D1_VALFRE + D1_SEGURO + D1_VALIMP5 + D1_VALCMAJ + D1_VALIMP6 -
       CASE WHEN D1_ALQIMP5 > 7.6 THEN ROUND(D1_BASIMP5 * 7.6 / 100, 2) ELSE D1_VALIMP5 - D1_VALCMAJ END -
       CASE WHEN D1_ALQIMP6 > 1.65 THEN ROUND(D1_BASIMP5 * 1.65 / 100, 2) ELSE D1_VALIMP6 END AS D1_CUS_CALC, 
       D1_CUSTO
  FROM SD1010 
 WHERE D_E_L_E_T_ = ' ' AND D1_TIPO_NF = '1'
   AND D1_TOTAL + D1_DESPESA + D1_VALFRE + D1_SEGURO + D1_VALIMP5 + D1_VALCMAJ + D1_VALIMP6 -
       CASE WHEN D1_ALQIMP5 > 7.6 THEN ROUND(D1_BASIMP5 * 7.6 / 100, 2) ELSE D1_VALIMP5 - D1_VALCMAJ END -
       CASE WHEN D1_ALQIMP6 > 1.65 THEN ROUND(D1_BASIMP5 * 1.65 / 100, 2) ELSE D1_VALIMP6 END <> D1_CUSTO
   AND LEN(D1_DOC) = 9
   AND (D1_ALQIMP5 <> 7.6 OR D1_ALQIMP6 <> 1.65)
 ORDER BY D1_DOC, D1_ITEM

-- Aplica o novo Custo
UPDATE D1_CUSTO =
       D1_TOTAL + D1_DESPESA + D1_VALFRE + D1_SEGURO + D1_VALIMP5 + D1_VALCMAJ + D1_VALIMP6 -
       CASE WHEN D1_ALQIMP5 > 7.6 THEN ROUND(D1_BASIMP5 * 7.6 / 100, 2) ELSE D1_VALIMP5 - D1_VALCMAJ END -
       CASE WHEN D1_ALQIMP6 > 1.65 THEN ROUND(D1_BASIMP5 * 1.65 / 100, 2) ELSE D1_VALIMP6 END
 WHERE D_E_L_E_T_ = ' ' AND D1_TIPO_NF = '1'
   AND D1_TOTAL + D1_DESPESA + D1_VALFRE + D1_SEGURO + D1_VALIMP5 + D1_VALCMAJ + D1_VALIMP6 -
       CASE WHEN D1_ALQIMP5 > 7.6 THEN ROUND(D1_BASIMP5 * 7.6 / 100, 2) ELSE D1_VALIMP5 - D1_VALCMAJ END -
       CASE WHEN D1_ALQIMP6 > 1.65 THEN ROUND(D1_BASIMP5 * 1.65 / 100, 2) ELSE D1_VALIMP6 END <> D1_CUSTO
   AND LEN(D1_DOC) = 9
   AND (D1_ALQIMP5 <> 7.6 OR D1_ALQIMP6 <> 1.65)
