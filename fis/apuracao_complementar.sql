SELECT SD1.D1_DOC, SD1.D1_SERIE, SD1.D1_FORNECE, SD1.D1_LOJA, SD1.D1_ICMSCOM
  FROM SF1010 SF1
  JOIN (SELECT SD1.D1_DOC, SD1.D1_SERIE, SD1.D1_FORNECE, SD1.D1_LOJA, SUM(D1_ICMSCOM) AS D1_ICMSCOM
          FROM SF1010 SF1
          JOIN SD1010 SD1 ON SD1.D1_DOC = SF1.F1_DOC AND SD1.D1_SERIE = SF1.F1_SERIE AND SD1.D1_FORNECE = SF1.F1_FORNECE
           AND SD1.D1_LOJA = SF1.F1_LOJA AND SD1.D_E_L_E_T_ = ' '
          JOIN SF4010 SF4 ON SF4.F4_CODIGO = SD1.D1_TES AND SF4.F4_ATUATF = 'S' AND SF1.D_E_L_E_T_ = ' '
         WHERE SF1.F1_DTDIGIT >= '20111101' AND SF1.F1_DTDIGIT <= '20111130' 
           AND SF1.F1_TIPO = 'C' AND SF1.D_E_L_E_T_ = ' '
      GROUP BY SD1.D1_DOC, SD1.D1_SERIE, SD1.D1_FORNECE, SD1.D1_LOJA) SD1 ON SD1.D1_DOC = SF1.F1_DOC
   AND SD1.D1_SERIE = SF1.F1_SERIE AND SD1.D1_FORNECE = SF1.F1_FORNECE AND SD1.D1_LOJA = SF1.F1_LOJA
 WHERE SF1.F1_DTDIGIT BETWEEN '20111101' AND '20111130' AND SF1.F1_TIPO = 'C' AND SF1.D_E_L_E_T_ = ' ';

SELECT CASE WHEN F3_CFO < '5' THEN '1' ELSE '5' END AS CFOP, SUM(F3_ICMSCOM) AS ICMS
  FROM SF3010 WHERE F3_ENTRADA BETWEEN '20111101' AND '20111130'
 GROUP BY CASE WHEN F3_CFO < '5' THEN '1' ELSE '5' END;

-- ICMS Complementar 
SELECT F3_ICMSCOM, F3_DTCANC, * FROM SF3010  
 WHERE F3_ENTRADA BETWEEN '20111101' AND '20111130' AND F3_ICMSCOM > 0 AND F3_DTCANC = '';
 
SELECT F3_ICMSCOM, F3_DTCANC, * FROM SF3010  
 WHERE F3_ENTRADA BETWEEN '20110101' AND '20111031' AND F3_ICMSCOM > 0 AND F3_DTCANC = ''
 ORDER BY F3_ENTRADA;