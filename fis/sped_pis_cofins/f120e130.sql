-- Bens com recuperação de crédito
select N1_NSERIE, N1_NFISCAL, N1_PRODUTO, 
       (SELECT COUNT(*) FROM SD1010 
         WHERE D1_FILIAL = '01' AND D_E_L_E_T_ = ' ' AND D1_SERIE = SN1010.N1_NSERIE
           AND D1_DOC = SN1010.N1_NFISCAL AND SUBSTRING(D1_CF, 1, 2) = '35') AS EXTERNO,
       N1_ORIGCRD, N1_CSTPIS, N1_CSTCOFI, N1_ALIQPIS, N1_ALIQCOF, N1_CODBCC, * 
  from SN1010 
 where N1_MESCPIS > 0
   and (SELECT COUNT(*) FROM SD1010 
         WHERE D1_FILIAL = '01' AND D_E_L_E_T_ = ' ' AND D1_SERIE = SN1010.N1_NSERIE
           AND D1_DOC = SN1010.N1_NFISCAL AND SUBSTRING(D1_CF, 1, 2) = '35') > 0;
 
-- Atributo por bem
update SN1010 
   set N1_ORIGCRD = case when N1_NSERIE = '2' and N1_NFISCAL = '001829' then '1' else '0' end, 
       N1_CSTPIS = case when N1_NSERIE = '2' and N1_NFISCAL = '001829' then '52' else '50' end, 
       N1_CSTCOFI = case when N1_NSERIE = '2' and N1_NFISCAL = '001829' then '52' else '50' end, 
       N1_ALIQPIS = 1.65, N1_ALIQCOF = 7.6, N1_CODBCC = '10'
 where N1_MESCPIS > 0;

-- Grupo de Bens x Ativos
update SN1010 
   set N1_DETPATR = NG_DETPATR, N1_UTIPATR = NG_UTIPATR
  from SNG010   
 where NG_GRUPO = N1_GRUPO;

-- Itens selecionados 
 SELECT N1_CBASE,N1_ITEM,N1_DESCRIC,N1_CALCPIS,SUM(N1_XPISAPR) AS N1_XPISAPR,SUM(N1_XCOFAPR) AS N1_XCOFAPR,SUM(SN4.N4_VLROC1) AS N4_VLROC1,SUM(SN1.N1_VLAQUIS) N1_VLAQUIS,N3_AQUISIC,N3_DINDEPR,N1_MESCPIS 
  FROM SN1010 SN1 
  JOIN SN3010 SN3 ON N3_FILIAL='01' AND N3_CBASE = N1_CBASE AND N3_ITEM = N1_ITEM AND SN3.D_E_L_E_T_=' ' 
  LEFT JOIN SN4010 SN4 ON N4_FILIAL='01' AND N4_CBASE = N1_CBASE AND N4_ITEM = N1_ITEM AND N4_TIPO = N3_TIPO AND N4_SEQ = N3_SEQ AND SN4.D_E_L_E_T_=' ' 
   AND N4_DATA>='19800101' AND N4_DATA<='20111231' AND N4_OCORR IN ('06','10') AND N4_TIPOCNT ='3' 
  WHERE SN1.D_E_L_E_T_=' ' AND N1_FILIAL='01' AND N1_CALCPIS IN ('1','3') AND N1_CBASE >= ' ' AND N1_CBASE <= 'ZZZZZZZZZ' AND N1_AQUISIC >= '19800101' 
    AND N1_AQUISIC <= '20111231' 
  GROUP BY N1_CBASE,N1_ITEM,N1_DESCRIC,N1_CALCPIS,N3_AQUISIC,N3_DINDEPR,N1_MESCPIS 
  ORDER BY N3_DINDEPR,N1_CBASE,N1_ITEM,N1_DESCRIC,N1_CALCPIS,N1_MESCPIS;
  
-- Notas de Importação
SELECT * FROM SD1010 WHERE D_E_L_E_T_ = ' ' AND SUBSTRING( D1_CF, 1, 3) = '355';  
