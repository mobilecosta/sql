-- Media das Vendas
SELECT SD2.D2_COD, MIN(LEFT(SD2.D2_CLASFIS, 1)) AS D2_ORIGEM, COUNT(*) AS VENDAS, SUM(SD2.D2_TOTAL) AS TOTAL, 
       SUM(SD2.D2_VALIPI) AS D2_IPI, 
       ROUND((SUM(SD2.D2_TOTAL / SD2.D2_QUANT) / COUNT(*)) - SUM(SD2.D2_VALIPI), 2) AS MEDIA, 
       MIN(SB1.B1_YPPECA) AS B1_YPPECA, MIN((SB1.B1_YQTDAG / 100)) AS B1_YQTDAG,
       MIN((SB1.B1_YPPECA * (SB1.B1_YQTDAG / 100)) * 1588.73) AS CFD_VPARIM,
       SUBSTRING(SD2.D2_EMISSAO, 5, 2) + LEFT(SD2.D2_EMISSAO, 4) AS CFD_PERVEN,
       ROW_NUMBER() OVER(ORDER BY SD2.D2_COD) AS RECNO
  FROM SD2010 SD2
  JOIN SB1010 SB1 ON SB1.D_E_L_E_T_ = ' ' AND SB1.B1_FILIAL = '01' AND SB1.B1_COD = SD2.D2_COD 
 WHERE SD2.D_E_L_E_T_ = ' ' AND SD2.D2_EMISSAO BETWEEN '20130801' AND '20130831'
   AND SD2.D2_CF IN ('6107','6101','6103','6105','6109','6111','6113','6116','6118','6122','6124','6125','6401','6402','6403','6404')
   AND SD2.D2_CLASFIS IN ('100','110','120','170','190','200','210','220','270','290','300','310','320','370','390')
   AND SD2.D2_COD = 'SOB05P2V200'
 GROUP BY SD2.D2_COD, SUBSTRING(SD2.D2_EMISSAO, 5, 2) + LEFT(SD2.D2_EMISSAO, 4)
 ORDER BY SD2.D2_COD, SUBSTRING(SD2.D2_EMISSAO, 5, 2) + LEFT(SD2.D2_EMISSAO, 4);

-- Inclusão dos registros da FCI
SELECT * FROM CFD010;
DELETE FROM CFD010 WHERE CFD_PERCAL = '032014';
 
INSERT INTO CFD010(CFD_FILIAL, CFD_PERCAL, CFD_PERVEN, CFD_COD, CFD_VPARIM, CFD_VSAIIE, CFD_CONIMP, CFD_ORIGEM, 
                   CFD_FILOP, R_E_C_N_O_)
SELECT '01' AS CFD_FILIAL, '032014' AS CFD_PERCAL, SUBSTRING(SD2.D2_EMISSAO, 5, 2) + LEFT(SD2.D2_EMISSAO, 4) AS CFD_PERVEN,
       SD2.D2_COD AS CFD_COD, ROUND(MIN((SB1.B1_YPPECA * (SB1.B1_YQTDAG / 100)) * 1588.73), 2) AS CFD_VPARIM, 
       ROUND((SUM(SD2.D2_TOTAL / SD2.D2_QUANT) / COUNT(*)) - SUM(SD2.D2_VALIPI), 2) AS CFD_VSAIIE, 
       ROUND(ROUND(MIN(SB1.B1_YPPECA * (SB1.B1_YQTDAG / 100) * 1588.73) / ((SUM(SD2.D2_TOTAL / SD2.D2_QUANT) / COUNT(*)) - SUM(SD2.D2_VALIPI)), 2) * 100, 2) AS CFD_CONIMP, 
       MIN(LEFT(SD2.D2_CLASFIS, 1)) AS D2_ORIGEM, '01' AS CFD_FILOP, 
       COALESCE((SELECT MAX(R_E_C_N_O_) FROM CFD010), 0) + ROW_NUMBER() OVER(ORDER BY SD2.D2_COD) AS RECNO
  FROM SD2010 SD2
  JOIN SB1010 SB1 ON SB1.D_E_L_E_T_ = ' ' AND SB1.B1_FILIAL = '01' AND SB1.B1_COD = SD2.D2_COD 
 WHERE SD2.D_E_L_E_T_ = ' ' AND SD2.D2_EMISSAO BETWEEN '20140101' AND '20140131'
   AND SD2.D2_CF IN ('6107','6101','6103','6105','6109','6111','6113','6116','6118','6122','6124','6125','6401','6402','6403','6404')
   AND SD2.D2_CLASFIS IN ('100','110','120','170','190','200','210','220','270','290','300','310','320','370','390')
   AND SB1.B1_YPPECA > 0 AND SB1.B1_YQTDAG > 0
   AND (SD2.D2_COD = 'SO04001A125' OR SD2.D2_COD = 'SOD05P2V325')
 GROUP BY SD2.D2_COD, SUBSTRING(SD2.D2_EMISSAO, 5, 2) + LEFT(SD2.D2_EMISSAO, 4)
 ORDER BY SD2.D2_COD, SUBSTRING(SD2.D2_EMISSAO, 5, 2) + LEFT(SD2.D2_EMISSAO, 4);
 
SELECT * 
  FROM SD2010 SD2
 WHERE SD2.D_E_L_E_T_ = ' ' 
   AND SD2.D2_EMISSAO BETWEEN '20130801' AND '20130831'
   AND SD2.D2_CF IN ('6107','6101','6103','6105','6109','6111','6113','6116','6118','6122','6124','6125','6401','6402','6403','6404')
   AND SD2.D2_CLASFIS IN ('100','110','120','170','190','200','210','220','270','290','300','310','320','370','390')
   AND SD2.D2_COD = 'SOB05P2V200';
   
SELECT D2_CLASFIS, D2_FCICOD, * FROM SD2010
WHERE D2_DOC = '000026796';   