-- Valor do ICMS - CIAP x Entrada da Nota
select D1_FORNECE, D1_LOJA, D1_DOC, D1_SERIE, D1_VALICM, * from SD1010
 where D_E_L_E_T_ = ' ' 
   and exists(select 1 from SF9010 where D_E_L_E_T_ = ' ' AND F9_CODIGO = '000668' 
   and F9_FORNECE = SD1010.D1_FORNECE AND F9_LOJAFOR = SD1010.D1_LOJA AND F9_DOCNFE = SD1010.D1_DOC 
   and F9_SERNFE = SD1010.D1_SERIE AND F9_ITEMNFE = SD1010.D1_ITEM);

-- Tabela com registros a serem corrigidos o valor do ICMS no item da nota (SD1)
SELECT * INTO SD1_CIAP
  FROM (
SELECT SD1.D1_VALICM, SF9.F9_VALICMS, SN3.N3_CUSTBEM, SFA.FA_FILIAL,SFA.FA_CODIGO,SFA.FA_TIPO,SFA.FA_MOTIVO,SFA.FA_DATA,SFA.FA_FATOR,SFA.FA_VALOR, SFA.FA_TOTSAI, SFA.FA_TOTTRIB,
       SF9.R_E_C_N_O_ SF9RECNO, SFT.R_E_C_N_O_ SFTRECNO, SFT2.R_E_C_N_O_ SFT2RECNO, SD1.R_E_C_N_O_ SD1RECNO, SD2.R_E_C_N_O_ SD2RECNO, 
       SA1.R_E_C_N_O_ SA1RECNO, SA2.R_E_C_N_O_ SA2RECNO, SB1.R_E_C_N_O_ SB1RECNO, SB12.R_E_C_N_O_ SB12RECNO,SN1.R_E_C_N_O_ SN1RECNO,SN3.R_E_C_N_O_ SN3RECNO,
       SFT3.R_E_C_N_O_ FTRECDEVOL,SD23.R_E_C_N_O_ D2RECDEVOL,SA23.R_E_C_N_O_ A2RECDEVOL,SB13.R_E_C_N_O_ B1RECDEVOL
  from SFA010 SFA
  JOIN SF9010 SF9 ON SF9.F9_FILIAL='01' AND SF9.F9_CODIGO=SFA.FA_CODIGO AND SF9.D_E_L_E_T_=' '
  LEFT JOIN SFT010 SFT ON SFT.FT_FILIAL='01' AND SFT.FT_TIPOMOV='E' AND SFT.FT_SERIE=SF9.F9_SERNFE AND SFT.FT_NFISCAL=SF9.F9_DOCNFE AND SFT.FT_CLIEFOR=SF9.F9_FORNECE AND SFT.FT_LOJA=SF9.F9_LOJAFOR AND SFT.FT_ITEM=SF9.F9_ITEMNFE AND SFT.D_E_L_E_T_=' '
  LEFT JOIN SD1010 SD1 ON SD1.D1_FILIAL='01' AND SD1.D1_DOC=SFT.FT_NFISCAL AND SD1.D1_SERIE=SFT.FT_SERIE AND SD1.D1_FORNECE=SFT.FT_CLIEFOR AND SD1.D1_LOJA=SFT.FT_LOJA AND SD1.D1_COD=SFT.FT_PRODUTO AND SD1.D1_ITEM=SFT.FT_ITEM AND SD1.D_E_L_E_T_=' '
  LEFT JOIN SA2010 SA2 ON SA2.A2_FILIAL='  ' AND SA2.A2_COD=SF9.F9_FORNECE AND SA2.A2_LOJA=SF9.F9_LOJAFOR AND SA2.D_E_L_E_T_=' '
  LEFT JOIN SB1010 SB1 ON SB1.B1_FILIAL='01' AND SB1.B1_COD=SFT.FT_PRODUTO AND SB1.D_E_L_E_T_=' '
  LEFT JOIN SFT010 SFT2 ON SFT2.FT_FILIAL='01' AND SFT2.FT_TIPOMOV='S' AND SFT2.FT_SERIE=SF9.F9_SERNFS AND SFT2.FT_NFISCAL=SF9.F9_DOCNFS AND SFT2.FT_CLIEFOR=SF9.F9_CLIENTE AND SFT2.FT_LOJA=SF9.F9_LOJACLI AND SFT2.FT_ITEM= SF9.F9_ITEMNFS AND SFT2.D_E_L_E_T_=' '
  LEFT JOIN SD2010 SD2  ON SD2.D2_FILIAL='01' AND SD2.D2_DOC=SFT2.FT_NFISCAL AND SD2.D2_SERIE=SFT2.FT_SERIE AND SD2.D2_CLIENTE=SFT2.FT_CLIEFOR AND SD2.D2_LOJA=SFT2.FT_LOJA AND SD2.D2_COD=SFT2.FT_PRODUTO AND SD2.D2_ITEM=SFT2.FT_ITEM AND SD2.D_E_L_E_T_=' '
  LEFT JOIN SA1010 SA1 ON SA1.A1_FILIAL='  ' AND SA1.A1_COD=SF9.F9_CLIENTE AND SA1.A1_LOJA=SF9.F9_LOJACLI AND SA1.D_E_L_E_T_=' '
  LEFT JOIN SB1010 SB12 ON SB12.B1_FILIAL='01' AND SB12.B1_COD=SFT2.FT_PRODUTO AND SB12.D_E_L_E_T_=' '
  LEFT JOIN SFT010 SFT3 ON SFT3.FT_FILIAL='01' AND SFT3.FT_TIPOMOV='S'  AND SFT3.FT_SERIE=SF9.F9_SERNFS AND SFT3.FT_NFISCAL=SF9.F9_DOCNFS   AND SFT3.FT_CLIEFOR=SF9.F9_FORNECE AND SFT3.FT_LOJA=SF9.F9_LOJAFOR AND SFT3.FT_ITEM=SF9.F9_ITEMNFS AND SFT3.D_E_L_E_T_=' '
  LEFT JOIN SD2010 SD23 ON SD23.D2_FILIAL='01' AND SD23.D2_DOC=SFT3.FT_NFISCAL AND SD23.D2_SERIE=SFT3.FT_SERIE AND SD23.D2_CLIENTE=SFT3.FT_CLIEFOR AND SD23.D2_LOJA=SFT3.FT_LOJA      AND SD23.D2_COD=SFT3.FT_PRODUTO AND SD23.D2_ITEM=SFT3.FT_ITEM AND SD23.D_E_L_E_T_=' '
  LEFT JOIN SA2010 SA23 ON SA23.A2_FILIAL='  ' AND SA23.A2_COD=SF9.F9_FORNECE  AND SA23.A2_LOJA=SF9.F9_LOJAFOR AND SA23.D_E_L_E_T_=' '
  LEFT JOIN SB1010 SB13 ON SB13.B1_FILIAL='01' AND SB13.B1_COD=SFT3.FT_PRODUTO AND SB13.D_E_L_E_T_=' '				
  LEFT JOIN SN1010 SN1 ON SN1.N1_FILIAL='01' AND SN1.N1_CODCIAP=SF9.F9_CODIGO AND SN1.D_E_L_E_T_=' '
  LEFT JOIN SN3010 SN3 ON SN3.N3_FILIAL='01' AND SN3.N3_CBASE=SN1.N1_CBASE AND SN3.N3_ITEM=SN1.N1_ITEM AND SN3.D_E_L_E_T_=' '
 where SFA.FA_FILIAL='01' AND SFA.FA_DATA>='20130101' AND SFA.FA_DATA<='20130131' AND SFA.D_E_L_E_T_ = ' '
   AND SD1.D1_VALICM = 0) CIAP

-- Script para correção a partir da tabela gerada
UPDATE SD1010
   SET D1_VALICM = SD1_CIAP.F9_VALICMS
  FROM SD1_CIAP
 WHERE SD1010.R_E_C_N_O_ = SD1_CIAP.SD1RECNO;